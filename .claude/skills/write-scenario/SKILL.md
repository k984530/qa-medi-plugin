---
name: write-scenario
description: 기획서/정책서를 기반으로 테스트 시나리오를 작성합니다. Confluence Page ID 또는 시나리오 파일 경로를 전달하세요.
argument-hint: [Confluence Page ID 또는 파일 경로]
---

# 시나리오 작성

입력: $ARGUMENTS

---

## 사전 준비: Atlassian MCP 연결

시나리오 작성을 위해 Confluence 조회가 필요합니다. Atlassian MCP가 연결되어 있지 않으면 아래 절차를 안내하세요.

### 패키지 설치
```bash
pip install mcp-atlassian
```

### .mcp.json 설정
```json
{
  "mcpServers": {
    "atlassian": {
      "command": "mcp-atlassian",
      "args": [],
      "env": {
        "CONFLUENCE_URL": "https://your-domain.atlassian.net/wiki",
        "CONFLUENCE_USERNAME": "your-email@example.com",
        "CONFLUENCE_API_TOKEN": "YOUR_CONFLUENCE_API_TOKEN"
      }
    }
  }
}
```

> **주의:** `command`는 반드시 `mcp-atlassian`으로 설정. `npx`나 `uvx`로 변경하지 말 것.

### API Token 발급
1. https://id.atlassian.com/manage-profile/security/api-tokens 접속
2. [Create API token] 클릭
3. 생성된 토큰을 `CONFLUENCE_API_TOKEN`에 입력

---

## 0. 문서 형식 (로컬 저장 & Confluence 공통)

### 저장 경로 (로컬)
```
data/scenarios/{제품명}_{버전}_{기능명}_scenario.md
```

**예시:**
- `data/scenarios/say_v1.2.0_process_guide_scenario.md`
- `data/scenarios/bay_v1.0.0_stock_management_scenario.md`

### 파일명 규칙
- 제품명: 소문자, 공백 없음
- 버전: `v{major}.{minor}.{patch}` 형식
- 기능명: 소문자, 언더스코어 구분
- 접미사: `_scenario.md`

### 마크다운 구조 (최종 형식)

```markdown
# {제품명} v{버전} {기능명} 시나리오

| 항목 | 내용 |
|------|------|
| 버전 | v{버전} |
| 작성일 | YYYY-MM-DD |
| 참고 문서 | 정책서 v{N}, 기획서 v{N}, 디자인 문서 |

---

## 목차
- 1. {대분류} 시나리오
- 2. {대분류} 시나리오
- ...

---

# 1. {대분류} 시나리오

## 1.1 {중분류}

### 1.1.1 {소분류}

1. {조건} → {결과}
2. {조건} → {결과}
```

### 헤딩 레벨

| 레벨 | 용도 | 예시 |
|------|------|------|
| H1 (`#`) | 시나리오 대분류 | `# 1. 프로세스 유형 시나리오` |
| H2 (`##`) | 중분류 (기능/화면 단위) | `## 1.1 프로세스 자동 적용` |
| H3 (`###`) | 소분류 (세부 케이스) | `### 1.1.1 초진 프로세스 적용` |

> **참고:** 문서 제목은 Confluence 페이지 타이틀로 설정. 본문 내 H1은 시나리오 대분류에 사용.

### 정보 테이블
- 문서 상단에 버전, 작성일, 참고 문서를 테이블로 표기
- Confluence 업로드 시 페이지 타이틀 = `{제품명} v{버전} {기능명} 시나리오`

### 목차
- `## 목차` 헤딩 아래 H1 섹션명을 불릿 리스트로 나열
- Confluence 업로드 시 TOC 매크로로 대체됨 (자동 링크 생성)
- 삭제된 시나리오는 목차에서도 제거

### 동작-결과 표기
- `{조건/동작} → {결과}` 형식 통일
- 번호 리스트 사용 (1. 2. 3.)

### 결과 문체 규칙
- **긍정**: ~됨, ~적용됨, ~표시됨, ~유지됨, ~노출됨
- **부정**: ~되지 않음, ~불가함, ~없음
- **지양**: ~된다, ~합니다, ~해야 함 (서술형 혼용 금지)

**예시:**
```
✅ 초진 프로세스(11단계) 자동 적용됨
✅ 이력으로 인정되지 않음
✅ 상담 종료까지 유지됨 (변경 불가)
❌ 초진 프로세스가 자동으로 적용된다
❌ 이력으로 인정되지 않습니다
```

---

## 1. 기획서/정책서 모순 검토 (시나리오 작성 전 필수 수행)

### 1.1 조건-결과 모순
- "A 불가" 조건인데 "A 후 동작" 정의된 경우
- 예: "상담 내역 있으면 고객 삭제 불가" + "삭제 후 상담 이력 유지"
- → 삭제가 불가능한데 삭제 후 동작을 정의하는 것은 모순

### 1.2 상태 흐름 오류
- 도달 불가능한 상태 정의
- 순환 참조 (A→B→A 무한루프)
- 상태 전이 누락 (A에서 B로 갈 수 없는데 B 상태 존재)

### 1.3 섹션 간 불일치
- 같은 기능이 다른 섹션에서 다르게 정의
- 권한/역할별 동작 충돌
- 예: 3장에서 "관리자만 삭제 가능" vs 5장에서 "모든 사용자 삭제 가능"

### 1.4 경계 조건 누락/충돌
- 0건, 최대값, 빈 값 처리 미정의
- "이상/이하" vs "초과/미만" 혼용

### 1.5 용어 불일치
- 같은 개념에 다른 용어 사용
- 예: "고객" vs "사용자" vs "회원" 혼용

### 모순 검토 출력 형식
```
## 문서 모순/불일치 검토 결과

### 발견된 문제
| # | 유형 | 위치 | 내용 | 심각도 |
|---|------|------|------|--------|
| 1 | 조건-결과 모순 | 4.3절 | "삭제 불가" 조건에서 "삭제 후 동작" 정의 | 높음 |

### 권장 조치
- 기획자에게 확인 필요한 항목 목록
- 시나리오 작성 시 주의사항
```

---

## 2. 시나리오 검토 (버전 변경 시)

**입력 예시:**
```
기획서랑 정책서 버전 v1.1.0-4 업데이트 됐어
변경이력은:
- 10-3. AI 가이드 활성화 토글 시점 변경
- 5-6. 분석 미해당 처리 추가
```

**수행 작업:**
1. 변경이력 텍스트 파싱
2. Confluence에서 해당 섹션 내용 조회
3. 기존 시나리오와 비교
4. 영향 분석 결과 출력

**출력 형식:**
```
## v{현재버전} vs v{이전버전} 변경사항

### 추가된 내용
- {섹션번호}. {제목}: {내용 요약}

### 수정된 내용
- {섹션번호}. {제목}: {변경 전} → {변경 후}

### 삭제된 내용
- {섹션번호}. {제목}

### 영향받는 TC
- TC-{번호}: {영향 내용}
```

---

## 3. Confluence 업로드

**입력:** 시나리오 마크다운 파일 + Page ID

### 업로드 규칙
- 페이지 타이틀: `{제품명} v{버전} {기능명} 시나리오`
- 본문: Section 0의 마크다운 구조와 동일
- 목차: `## 목차` 부분을 Confluence TOC 매크로로 대체
- `content_format: "markdown"` 사용 (신규 작성 또는 전체 덮어쓰기 시)
- 히스토리 페이지 동시 업데이트

### Confluence 페이지 본문 구성

```
┌─────────────────────────────────────────┐
│ 페이지 타이틀 (Confluence 자동 표시)       │
├─────────────────────────────────────────┤
│ 정보 테이블 (버전, 작성일, 참고 문서)       │
├─────────────────────────────────────────┤
│ ── 구분선 ──                             │
├─────────────────────────────────────────┤
│ 목차 (TOC 매크로, H1 섹션 링크 자동 생성)  │
├─────────────────────────────────────────┤
│ ── 구분선 ──                             │
├─────────────────────────────────────────┤
│ # 1. 대분류 시나리오                      │
│   ## 1.1 중분류                          │
│     ### 1.1.1 소분류                     │
│       1. 조건 → 결과                     │
├─────────────────────────────────────────┤
│ # 2. 대분류 시나리오                      │
│   ...                                   │
└─────────────────────────────────────────┘
```

### 업데이트 체크리스트
- [ ] 페이지 타이틀 버전 번호 업데이트
- [ ] 정보 테이블 버전/작성일/참고 문서 업데이트
- [ ] 목차 섹션 업데이트 (추가/삭제 반영)
- [ ] 시나리오 내용 업데이트
- [ ] 히스토리 페이지 업데이트

---

## 4. Confluence MCP 사용 규칙

- **부분 수정 시 storage format 필수**: `content_format: "storage"` 사용
- **마크다운 사용 금지 (부분 수정 시)**: 기존 서식 초기화됨
- **전체 페이지 신규 작성 시에만 마크다운 허용**

### 부분 수정 절차
```
1. confluence_get_page로 현재 페이지 조회 (convert_to_markdown: false)
2. 반환된 storage format HTML에서 수정할 부분만 변경
3. confluence_update_page로 업데이트 (content_format: "storage")
```

### 테이블 수정 시 보존 속성
- colgroup/col style (컬럼 너비)
- data-table-width (테이블 전체 너비)
- data-layout (center, default 등)
- ac:local-id (Confluence 내부 ID)
- ac:link (페이지 내 링크)

---

## 5. 리뷰 옵션

작성 완료 후 리뷰가 필요하면 `/review-scenario` 스킬의 기준으로 검토한다.
